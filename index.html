<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>نظام إدارة التعويضات | Compensation Management System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <style>
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1050;
    }
    .status-pending { background-color: #fff3cd; }
    .status-responded { background-color: #cfe2ff; }
    .status-resolved { background-color: #d1e7dd; }
    .action-buttons .btn { margin: 0 2px; }
    .lang-toggle {
      position: absolute;
      top: 15px;
      left: 15px;
      z-index: 1000;
    }
    @media (max-width: 768px) {
      .action-buttons .btn { 
        display: block; 
        width: 100%;
        margin: 2px 0;
      }
    }
  </style>
</head>
<body class="container py-4">
  <!-- Language Toggle -->
  <div class="lang-toggle">
    <button class="btn btn-sm btn-outline-secondary" onclick="toggleLanguage()">
      <i class="bi bi-translate"></i> <span id="langToggleText">English</span>
    </button>
  </div>

  <h2 class="mb-4 text-center">📋 <span id="systemTitle">نظام إدارة التعويضات</span></h2>
  
  <!-- Stats Cards -->
  <div class="row mb-4">
    <div class="col-md-3 mb-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title" id="totalCasesTitle">إجمالي الحالات</h5>
          <h2 class="text-primary" id="totalCases">0</h2>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title" id="pendingTitle">قيد الانتظار</h5>
          <h2 class="text-warning" id="pendingCases">0</h2>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title" id="resolvedTitle">تم الحل</h5>
          <h2 class="text-success" id="resolvedCases">0</h2>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title" id="totalAmountTitle">إجمالي المبلغ</h5>
          <h2 class="text-info" id="totalAmount">0</h2>
        </div>
      </div>
    </div>
  </div>

  <!-- Controls -->
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
    <div>
      <button class="btn btn-primary mb-2 mb-md-0" data-bs-toggle="modal" data-bs-target="#caseModal" onclick="openAddCase()">
        <i class="bi bi-plus-circle"></i> <span id="addCaseBtn">➕ إضافة حالة جديدة</span>
      </button>
      <button class="btn btn-success ms-2 mb-2 mb-md-0" onclick="exportData()">
        <i class="bi bi-download"></i> <span id="exportBtn">تصدير البيانات</span>
      </button>
    </div>
    <div class="d-flex">
      <input type="text" id="searchInput" class="form-control me-2" placeholder="بحث في الحالات..." onkeyup="searchCases()">
      <select id="filterStatus" class="form-select" onchange="filterByStatus()">
        <option value="all" id="filterAll">الكل</option>
        <option value="pending" id="filterPending">قيد الانتظار</option>
        <option value="responded" id="filterResponded">تم الرد</option>
        <option value="resolved" id="filterResolved">تم الحل</option>
      </select>
    </div>
  </div>

  <!-- The Modal (Add/Edit) -->
  <div class="modal fade" id="caseModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">إضافة حالة جديدة</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="caseForm">
            <input type="hidden" id="editIndex">
            <div class="mb-3">
              <label for="orderId" class="form-label" id="orderIdLabel">رقم الطلب</label>
              <input type="text" id="orderId" class="form-control" required>
              <div class="invalid-feedback" id="orderIdError">يرجى إدخال رقم الطلب</div>
            </div>
            <div class="mb-3">
              <label for="branch" class="form-label" id="branchLabel">الفرع</label>
              <input type="text" id="branch" class="form-control">
            </div>
            <div class="mb-3">
              <label for="amount" class="form-label" id="amountLabel">المبلغ</label>
              <input type="number" id="amount" class="form-control" min="0" step="0.01" required>
              <div class="invalid-feedback" id="amountError">يرجى إدخال مبلغ صحيح</div>
            </div>
            <div class="mb-3">
              <label for="reason" class="form-label" id="reasonLabel">السبب</label>
              <select id="reason" class="form-control">
                <option value="leak">تسريب</option>
                <option value="orderError">خطأ بالطلب</option>
                <option value="delay">تأخير</option>
                <option value="other">أخرى</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="status" class="form-label" id="statusLabel">الحالة</label>
              <select id="status" class="form-control">
                <option value="pending">قيد الانتظار</option>
                <option value="responded">تم الرد</option>
                <option value="resolved">تم الحل</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="notes" class="form-label" id="notesLabel">ملاحظات</label>
              <textarea id="notes" class="form-control" rows="3"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancelBtn">إلغاء</button>
          <button type="button" class="btn btn-success" onclick="saveCase()" id="saveBtn">💾 حفظ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Cases Table -->
  <div class="table-responsive">
    <table id="casesTable" class="table table-bordered table-striped mt-3 text-center align-middle">
      <thead class="table-dark">
        <tr>
          <th id="thOrderId">رقم الطلب</th>
          <th id="thBranch">الفرع</th>
          <th id="thAmount">المبلغ</th>
          <th id="thReason">السبب</th>
          <th id="thStatus">الحالة</th>
          <th id="thNotes">ملاحظات</th>
          <th id="thActions">إجراءات</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Toast Container -->
  <div class="toast-container"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Language translations
    const translations = {
      ar: {
        systemTitle: "نظام إدارة التعويضات",
        totalCasesTitle: "إجمالي الحالات",
        pendingTitle: "قيد الانتظار",
        resolvedTitle: "تم الحل",
        totalAmountTitle: "إجمالي المبلغ",
        addCaseBtn: "➕ إضافة حالة جديدة",
        exportBtn: "تصدير البيانات",
        filterAll: "الكل",
        filterPending: "قيد الانتظار",
        filterResponded: "تم الرد",
        filterResolved: "تم الحل",
        modalTitleAdd: "إضافة حالة جديدة",
        modalTitleEdit: "تعديل حالة",
        orderIdLabel: "رقم الطلب",
        branchLabel: "الفرع",
        amountLabel: "المبلغ",
        reasonLabel: "السبب",
        statusLabel: "الحالة",
        notesLabel: "ملاحظات",
        cancelBtn: "إلغاء",
        saveBtn: "💾 حفظ",
        editBtn: "✏️ تعديل",
        deleteBtn: "🗑️ حذف",
        confirmDelete: "⚠️ هل أنت متأكد أنك تريد حذف هذه الحالة؟",
        orderIdError: "يرجى إدخال رقم الطلب",
        amountError: "يرجى إدخال مبلغ صحيح",
        successSave: "تم حفظ الحالة بنجاح",
        successDelete: "تم حذف الحالة بنجاح",
        noData: "لا توجد حالات مسجلة",
        searchPlaceholder: "بحث في الحالات...",
        thOrderId: "رقم الطلب",
        thBranch: "الفرع",
        thAmount: "المبلغ",
        thReason: "السبب",
        thStatus: "الحالة",
        thNotes: "ملاحظات",
        thActions: "إجراءات",
        langToggleText: "English",
        reasonLeak: "تسريب",
        reasonOrderError: "خطأ بالطلب",
        reasonDelay: "تأخير",
        reasonOther: "أخرى",
        statusPending: "قيد الانتظار",
        statusResponded: "تم الرد",
        statusResolved: "تم الحل"
      },
      en: {
        systemTitle: "Compensation Management System",
        totalCasesTitle: "Total Cases",
        pendingTitle: "Pending",
        resolvedTitle: "Resolved",
        totalAmountTitle: "Total Amount",
        addCaseBtn: "➕ Add New Case",
        exportBtn: "Export Data",
        filterAll: "All",
        filterPending: "Pending",
        filterResponded: "Responded",
        filterResolved: "Resolved",
        modalTitleAdd: "Add New Case",
        modalTitleEdit: "Edit Case",
        orderIdLabel: "Order ID",
        branchLabel: "Branch",
        amountLabel: "Amount",
        reasonLabel: "Reason",
        statusLabel: "Status",
        notesLabel: "Notes",
        cancelBtn: "Cancel",
        saveBtn: "💾 Save",
        editBtn: "✏️ Edit",
        deleteBtn: "🗑️ Delete",
        confirmDelete: "⚠️ Are you sure you want to delete this case?",
        orderIdError: "Please enter an order ID",
        amountError: "Please enter a valid amount",
        successSave: "Case saved successfully",
        successDelete: "Case deleted successfully",
        noData: "No cases recorded",
        searchPlaceholder: "Search cases...",
        thOrderId: "Order ID",
        thBranch: "Branch",
        thAmount: "Amount",
        thReason: "Reason",
        thStatus: "Status",
        thNotes: "Notes",
        thActions: "Actions",
        langToggleText: "العربية",
        reasonLeak: "Leak",
        reasonOrderError: "Order Error",
        reasonDelay: "Delay",
        reasonOther: "Other",
        statusPending: "Pending",
        statusResponded: "Responded",
        statusResolved: "Resolved"
      }
    };

    // Global variables
    let cases = [];
    let currentLang = 'ar';
    let filteredCases = [];

    // Initialize the app
    document.addEventListener('DOMContentLoaded', function() {
      loadFromLocalStorage();
      renderTable();
      updateStats();
      updateLanguage();
    });

    // Language functions
    function toggleLanguage() {
      currentLang = currentLang === 'ar' ? 'en' : 'ar';
      document.documentElement.lang = currentLang;
      document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
      updateLanguage();
      renderTable();
    }

    function updateLanguage() {
      const t = translations[currentLang];
      
      // Update all text elements
      document.getElementById('systemTitle').textContent = t.systemTitle;
      document.getElementById('totalCasesTitle').textContent = t.totalCasesTitle;
      document.getElementById('pendingTitle').textContent = t.pendingTitle;
      document.getElementById('resolvedTitle').textContent = t.resolvedTitle;
      document.getElementById('totalAmountTitle').textContent = t.totalAmountTitle;
      document.getElementById('addCaseBtn').innerHTML = `<i class="bi bi-plus-circle"></i> ${t.addCaseBtn}`;
      document.getElementById('exportBtn').innerHTML = `<i class="bi bi-download"></i> ${t.exportBtn}`;
      document.getElementById('filterAll').textContent = t.filterAll;
      document.getElementById('filterPending').textContent = t.filterPending;
      document.getElementById('filterResponded').textContent = t.filterResponded;
      document.getElementById('filterResolved').textContent = t.filterResolved;
      document.getElementById('cancelBtn').textContent = t.cancelBtn;
      document.getElementById('saveBtn').innerHTML = t.saveBtn;
      document.getElementById('searchInput').placeholder = t.searchPlaceholder;
      document.getElementById('langToggleText').textContent = t.langToggleText;
      
      // Update table headers
      document.getElementById('thOrderId').textContent = t.thOrderId;
      document.getElementById('thBranch').textContent = t.thBranch;
      document.getElementById('thAmount').textContent = t.thAmount;
      document.getElementById('thReason').textContent = t.thReason;
      document.getElementById('thStatus').textContent = t.thStatus;
      document.getElementById('thNotes').textContent = t.thNotes;
      document.getElementById('thActions').textContent = t.thActions;
      
      // Update form labels
      document.getElementById('orderIdLabel').textContent = t.orderIdLabel;
      document.getElementById('branchLabel').textContent = t.branchLabel;
      document.getElementById('amountLabel').textContent = t.amountLabel;
      document.getElementById('reasonLabel').textContent = t.reasonLabel;
      document.getElementById('statusLabel').textContent = t.statusLabel;
      document.getElementById('notesLabel').textContent = t.notesLabel;
      
      // Update form validation messages
      document.getElementById('orderIdError').textContent = t.orderIdError;
      document.getElementById('amountError').textContent = t.amountError;
      
      // Update form options
      updateFormOptions();
    }

    function updateFormOptions() {
      const t = translations[currentLang];
      
      // Update reason options
      const reasonSelect = document.getElementById('reason');
      reasonSelect.innerHTML = `
        <option value="leak">${t.reasonLeak}</option>
        <option value="orderError">${t.reasonOrderError}</option>
        <option value="delay">${t.reasonDelay}</option>
        <option value="other">${t.reasonOther}</option>
      `;
      
      // Update status options
      const statusSelect = document.getElementById('status');
      statusSelect.innerHTML = `
        <option value="pending">${t.statusPending}</option>
        <option value="responded">${t.statusResponded}</option>
        <option value="resolved">${t.statusResolved}</option>
      `;
    }

    // Case management functions
    function openAddCase() {
      const t = translations[currentLang];
      document.getElementById("modalTitle").textContent = t.modalTitleAdd;
      document.getElementById("caseForm").reset();
      document.getElementById("editIndex").value = "";
      document.getElementById("caseForm").classList.remove('was-validated');
    }

    function saveCase() {
      const t = translations[currentLang];
      const form = document.getElementById("caseForm");
      
      // Validate form
      if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return;
      }
      
      const caseData = {
        orderId: document.getElementById("orderId").value,
        branch: document.getElementById("branch").value,
        amount: parseFloat(document.getElementById("amount").value),
        reason: document.getElementById("reason").value,
        status: document.getElementById("status").value,
        notes: document.getElementById("notes").value,
        dateAdded: new Date().toISOString()
      };
      
      const editIndex = document.getElementById("editIndex").value;
      if (editIndex === "") {
        cases.push(caseData);
        showToast(t.successSave, 'success');
      } else {
        cases[editIndex] = caseData;
        showToast(t.successSave, 'success');
      }
      
      saveToLocalStorage();
      renderTable();
      updateStats();
      bootstrap.Modal.getInstance(document.getElementById("caseModal")).hide();
    }

    function editCase(index) {
      const t = translations[currentLang];
      const c = cases[index];
      document.getElementById("modalTitle").textContent = t.modalTitleEdit;
      document.getElementById("orderId").value = c.orderId;
      document.getElementById("branch").value = c.branch;
      document.getElementById("amount").value = c.amount;
      document.getElementById("reason").value = c.reason;
      document.getElementById("status").value = c.status;
      document.getElementById("notes").value = c.notes;
      document.getElementById("editIndex").value = index;
      document.getElementById("caseForm").classList.remove('was-validated');
      new bootstrap.Modal(document.getElementById("caseModal")).show();
    }

    function deleteCase(index) {
      const t = translations[currentLang];
      if (confirm(t.confirmDelete)) {
        cases.splice(index, 1);
        saveToLocalStorage();
        renderTable();
        updateStats();
        showToast(t.successDelete, 'danger');
      }
    }

    // Table rendering functions
    function renderTable() {
      const t = translations[currentLang];
      const tbody = document.querySelector("#casesTable tbody");
      tbody.innerHTML = "";
      
      const casesToRender = filteredCases.length > 0 ? filteredCases : cases;
      
      if (casesToRender.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="text-center py-3">${t.noData}</td></tr>`;
        return;
      }
      
      casesToRender.forEach((c, i) => {
        const originalIndex = cases.indexOf(c);
        const statusClass = `status-${c.status}`;
        const reasonText = getReasonText(c.reason);
        const statusText = getStatusText(c.status);
        
        tbody.innerHTML += `
          <tr>
            <td>${c.orderId}</td>
            <td>${c.branch}</td>
            <td>${c.amount.toFixed(2)}</td>
            <td>${reasonText}</td>
            <td><span class="badge ${statusClass}">${statusText}</span></td>
            <td>${c.notes}</td>
            <td class="action-buttons">
              <button class="btn btn-sm btn-warning" onclick="editCase(${originalIndex})" title="${t.editBtn}">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-sm btn-danger" onclick="deleteCase(${originalIndex})" title="${t.deleteBtn}">
                <i class="bi bi-trash"></i>
              </button>
            </td>
          </tr>
        `;
      });
    }

    function getReasonText(reasonKey) {
      const t = translations[currentLang];
      switch(reasonKey) {
        case 'leak': return t.reasonLeak;
        case 'orderError': return t.reasonOrderError;
        case 'delay': return t.reasonDelay;
        case 'other': return t.reasonOther;
        default: return reasonKey;
      }
    }

    function getStatusText(statusKey) {
      const t = translations[currentLang];
      switch(statusKey) {
        case 'pending': return t.statusPending;
        case 'responded': return t.statusResponded;
        case 'resolved': return t.statusResolved;
        default: return statusKey;
      }
    }

    // Stats functions
    function updateStats() {
      const totalCases = cases.length;
      const pendingCases = cases.filter(c => c.status === 'pending').length;
      const resolvedCases = cases.filter(c => c.status === 'resolved').length;
      const totalAmount = cases.reduce((sum, c) => sum + c.amount, 0);
      
      document.getElementById('totalCases').textContent = totalCases;
      document.getElementById('pendingCases').textContent = pendingCases;
      document.getElementById('resolvedCases').textContent = resolvedCases;
      document.getElementById('totalAmount').textContent = totalAmount.toFixed(2);
    }

    // Search and filter functions
    function searchCases() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const statusFilter = document.getElementById('filterStatus').value;
      
      filteredCases = cases.filter(c => {
        const matchesSearch = 
          c.orderId.toLowerCase().includes(searchTerm) ||
          c.branch.toLowerCase().includes(searchTerm) ||
          c.notes.toLowerCase().includes(searchTerm) ||
          getReasonText(c.reason).toLowerCase().includes(searchTerm) ||
          getStatusText(c.status).toLowerCase().includes(searchTerm);
          
        const matchesStatus = statusFilter === 'all' || c.status === statusFilter;
        
        return matchesSearch && matchesStatus;
      });
      
      renderTable();
    }

    function filterByStatus() {
      searchCases(); // Reuse search logic
    }

    // Data persistence functions
    function saveToLocalStorage() {
      localStorage.setItem('compensationCases', JSON.stringify(cases));
    }

    function loadFromLocalStorage() {
      const savedCases = localStorage.getItem('compensationCases');
      if (savedCases) {
        cases = JSON.parse(savedCases);
      }
    }

    // Export function
    function exportData() {
      const t = translations[currentLang];
      let csvContent = "data:text/csv;charset=utf-8,";
      
      // Add headers
      csvContent += `${t.thOrderId},${t.thBranch},${t.thAmount},${t.thReason},${t.thStatus},${t.thNotes}\n`;
      
      // Add data
      cases.forEach(c => {
        csvContent += `${c.orderId},${c.branch},${c.amount},${getReasonText(c.reason)},${getStatusText(c.status)},${c.notes}\n`;
      });
      
      // Create download link
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", `compensation_cases_${new Date().toISOString().slice(0,10)}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Toast notification function
    function showToast(message, type = 'info') {
      const toastContainer = document.querySelector('.toast-container');
      const toastId = 'toast-' + Date.now();
      
      const toastHTML = `
        <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="d-flex">
            <div class="toast-body">
              ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        </div>
      `;
      
      toastContainer.insertAdjacentHTML('beforeend', toastHTML);
      const toastElement = document.getElementById(toastId);
      const toast = new bootstrap.Toast(toastElement, { autohide: true, delay: 3000 });
      toast.show();
      
      toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
      });
    }
  </script>
</body>
</html>
