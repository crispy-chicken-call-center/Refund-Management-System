<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>نظام إدارة التعويضات | Compensation Management System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <style>
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1050;
    }
    .status-pending { background-color: #fff3cd; }
    .status-responded { background-color: #cfe2ff; }
    .status-resolved { background-color: #d1e7dd; }
    .status-disputed { background-color: #f8d7da; }
    .status-under_review { background-color: #d1ecf1; }
    .status-rejected { background-color: #e2e3e5; }
    .action-buttons .btn { margin: 0 2px; }
    .lang-toggle {
      position: absolute;
      top: 15px;
      left: 15px;
      z-index: 1000;
    }
    .item-row {
      border-bottom: 1px solid #eee;
      padding: 10px 0;
    }
    .item-row:last-child {
      border-bottom: none;
    }
    .image-preview {
      max-width: 100%;
      max-height: 200px;
      margin-top: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .response-section {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      margin-top: 15px;
    }
    .dispute-section {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      margin-top: 15px;
      border-left: 4px solid #dc3545;
    }
    .evidence-item {
      position: relative;
      display: inline-block;
      margin: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 5px;
    }
    .evidence-remove {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #dc3545;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 12px;
    }
    .email-template {
      background-color: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 15px;
      margin-top: 10px;
    }
    @media (max-width: 768px) {
      .action-buttons .btn { 
        display: block; 
        width: 100%;
        margin: 2px 0;
      }
    }
  </style>
</head>
<body class="container py-4">
  <!-- Language Toggle -->
  <div class="lang-toggle">
    <button class="btn btn-sm btn-outline-secondary" onclick="toggleLanguage()">
      <i class="bi bi-translate"></i> <span id="langToggleText">English</span>
    </button>
  </div>

  <h2 class="mb-4 text-center">📋 <span id="systemTitle">نظام إدارة التعويضات</span></h2>
  
  <!-- Stats Cards -->
  <div class="row mb-4">
    <div class="col-md-2 mb-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title" id="totalCasesTitle">إجمالي الحالات</h5>
          <h2 class="text-primary" id="totalCases">0</h2>
        </div>
      </div>
    </div>
    <div class="col-md-2 mb-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title" id="pendingTitle">قيد الانتظار</h5>
          <h2 class="text-warning" id="pendingCases">0</h2>
        </div>
      </div>
    </div>
    <div class="col-md-2 mb-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title" id="resolvedTitle">تم الحل</h5>
          <h2 class="text-success" id="resolvedCases">0</h2>
        </div>
      </div>
    </div>
    <div class="col-md-2 mb-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title" id="disputedTitle">متنازع عليها</h5>
          <h2 class="text-danger" id="disputedCases">0</h2>
        </div>
      </div>
    </div>
    <div class="col-md-2 mb-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title" id="underReviewTitle">قيد المراجعة</h5>
          <h2 class="text-info" id="underReviewCases">0</h2>
        </div>
      </div>
    </div>
    <div class="col-md-2 mb-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title" id="totalAmountTitle">إجمالي المبلغ</h5>
          <h2 class="text-info" id="totalAmount">0</h2>
        </div>
      </div>
    </div>
  </div>

  <!-- Controls -->
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
    <div>
      <button class="btn btn-primary mb-2 mb-md-0" data-bs-toggle="modal" data-bs-target="#caseModal" onclick="openAddCase()">
        <i class="bi bi-plus-circle"></i> <span id="addCaseBtn">➕ إضافة حالة جديدة</span>
      </button>
      <button class="btn btn-success ms-2 mb-2 mb-md-0" onclick="exportData()">
        <i class="bi bi-download"></i> <span id="exportBtn">تصدير البيانات</span>
      </button>
    </div>
    <div class="d-flex">
      <input type="text" id="searchInput" class="form-control me-2" placeholder="بحث في الحالات..." onkeyup="searchCases()">
      <select id="filterStatus" class="form-select" onchange="filterByStatus()">
        <option value="all" id="filterAll">الكل</option>
        <option value="pending" id="filterPending">قيد الانتظار</option>
        <option value="responded" id="filterResponded">تم الرد</option>
        <option value="resolved" id="filterResolved">تم الحل</option>
        <option value="disputed" id="filterDisputed">متنازع عليها</option>
        <option value="under_review" id="filterUnderReview">قيد المراجعة</option>
        <option value="rejected" id="filterRejected">مرفوض</option>
      </select>
    </div>
  </div>

  <!-- The Modal (Add/Edit) -->
  <div class="modal fade" id="caseModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">إضافة حالة جديدة</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="caseForm">
            <input type="hidden" id="editIndex">
            
            <!-- Order Information -->
            <div class="mb-3">
              <h5><i class="bi bi-receipt"></i> <span id="orderInfoTitle">معلومات الطلب</span></h5>
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label for="orderId" class="form-label" id="orderIdLabel">رقم الطلب</label>
                  <input type="text" id="orderId" class="form-control" required>
                  <div class="invalid-feedback" id="orderIdError">يرجى إدخال رقم الطلب</div>
                </div>
                <div class="col-md-4 mb-3">
                  <label for="outlet" class="form-label" id="outletLabel">الفرع</label>
                  <input type="text" id="outlet" class="form-control" required>
                </div>
                <div class="col-md-4 mb-3">
                  <label for="orderDate" class="form-label" id="orderDateLabel">تاريخ الطلب</label>
                  <input type="date" id="orderDate" class="form-control" required>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="partner" class="form-label" id="partnerLabel">الشريك</label>
                  <input type="text" id="partner" class="form-control" value="Accepted by partner" readonly>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="referenceId" class="form-label" id="referenceIdLabel">رقم المرجع</label>
                  <input type="text" id="referenceId" class="form-control">
                </div>
              </div>
            </div>
            
            <!-- Items -->
            <div class="mb-3">
              <h5><i class="bi bi-basket"></i> <span id="itemsTitle">العناصر</span></h5>
              <div id="itemsContainer">
                <div class="item-row">
                  <div class="row align-items-center">
                    <div class="col-md-1">
                      <label class="form-label" id="quantityLabel">الكمية</label>
                      <input type="number" class="form-control item-quantity" value="1" min="1">
                    </div>
                    <div class="col-md-4">
                      <label class="form-label" id="itemNameLabel">اسم العنصر</label>
                      <input type="text" class="form-control item-name" placeholder="اسم العنصر">
                    </div>
                    <div class="col-md-3">
                      <label class="form-label" id="itemCategoryLabel">الفئة</label>
                      <input type="text" class="form-control item-category" placeholder="الفئة">
                    </div>
                    <div class="col-md-2">
                      <label class="form-label" id="itemPriceLabel">السعر</label>
                      <input type="number" class="form-control item-price" value="0" min="0" step="0.01">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                      <button type="button" class="btn btn-danger btn-sm" onclick="removeItem(this)">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </div>
                  <div class="row mt-2">
                    <div class="col-12">
                      <label class="form-label" id="itemDescriptionLabel">الوصف</label>
                      <textarea class="form-control item-description" rows="1" placeholder="وصف العنصر"></textarea>
                    </div>
                  </div>
                </div>
              </div>
              <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addItem()">
                <i class="bi bi-plus"></i> <span id="addItemBtn">إضافة عنصر</span>
              </button>
            </div>
            
            <!-- Financial Details -->
            <div class="mb-3">
              <h5><i class="bi bi-cash-coin"></i> <span id="financialTitle">التفاصيل المالية</span></h5>
              <div class="row">
                <div class="col-md-3 mb-3">
                  <label for="basketAmount" class="form-label" id="basketAmountLabel">إجمالي السلة</label>
                  <input type="number" id="basketAmount" class="form-control" value="0" min="0" step="0.01" readonly>
                </div>
                <div class="col-md-3 mb-3">
                  <label for="promoCode" class="form-label" id="promoCodeLabel">رمز العرض</label>
                  <input type="text" id="promoCode" class="form-control">
                </div>
                <div class="col-md-3 mb-3">
                  <label for="promoAmount" class="form-label" id="promoAmountLabel">قيمة العرض</label>
                  <input type="number" id="promoAmount" class="form-control" value="0" min="0" step="0.01">
                </div>
                <div class="col-md-3 mb-3">
                  <label for="totalAmount" class="form-label" id="totalAmountLabel">الإجمالي</label>
                  <input type="number" id="totalAmount" class="form-control" value="0" min="0" step="0.01" readonly>
                </div>
                <div class="col-md-4 mb-3">
                  <label for="deductedAmount" class="form-label" id="deductedAmountLabel">المبلغ المسترد</label>
                  <input type="number" id="deductedAmount" class="form-control" value="0" min="0" step="0.01">
                </div>
                <div class="col-md-4 mb-3">
                  <label for="refundDate" class="form-label" id="refundDateLabel">تاريخ الاسترداد</label>
                  <input type="date" id="refundDate" class="form-control">
                </div>
                <div class="col-md-4 mb-3">
                  <label for="location" class="form-label" id="locationLabel">الموقع</label>
                  <input type="text" id="location" class="form-control" placeholder="موقع التسليم">
                </div>
              </div>
            </div>
            
            <!-- Reason and Customer Feedback -->
            <div class="mb-3">
              <h5><i class="bi bi-chat-dots"></i> <span id="reasonTitle">السبب وملاحظات العميل</span></h5>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="reason" class="form-label" id="reasonLabel">السبب الرئيسي</label>
                  <select id="reason" class="form-control">
                    <option value="spilled">تسريب / تلف</option>
                    <option value="wrong">عنصر خاطئ</option>
                    <option value="missing_main">عنصر رئيسي مفقود</option>
                    <option value="missing_side">عنصر جانبي مفقود</option>
                    <option value="overcooked">الطعام مطهو أكثر من اللازم</option>
                    <option value="undercooked">الطعام غير ناضج</option>
                    <option value="smell">رائحة كريهة</option>
                    <option value="hair">شعر في الطعام</option>
                    <option value="inedible">الطعام غير صالح للأكل</option>
                    <option value="other">أخرى</option>
                  </select>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="customerReason" class="form-label" id="customerReasonLabel">سبب العميل</label>
                  <input type="text" id="customerReason" class="form-control" placeholder="سبب العميل المحدد">
                </div>
                <div class="col-12 mb-3">
                  <label class="form-label" id="selectedItemsLabel">العناصر المحددة من العميل</label>
                  <div id="selectedItemsContainer" class="border rounded p-2 bg-light">
                    <p class="text-muted mb-0" id="noItemsSelected">لا توجد عناصر محددة</p>
                  </div>
                </div>
                <div class="col-12 mb-3">
                  <label for="customerNotes" class="form-label" id="customerNotesLabel">ملاحظات العميل</label>
                  <textarea id="customerNotes" class="form-control" rows="3" placeholder="ملاحظات العميل"></textarea>
                </div>
                <div class="col-12 mb-3">
                  <label for="itemImage" class="form-label" id="itemImageLabel">صورة العنصر</label>
                  <input type="file" id="itemImage" class="form-control" accept="image/*" onchange="previewImage(this)">
                  <img id="imagePreview" class="image-preview d-none" alt="Image preview">
                </div>
              </div>
            </div>
            
            <!-- Response Section -->
            <div class="response-section">
              <h5><i class="bi bi-reply"></i> <span id="responseTitle">الرد على العميل</span></h5>
              <div class="row">
                <div class="col-12 mb-3">
                  <label for="response" class="form-label" id="responseLabel">نص الرد</label>
                  <textarea id="response" class="form-control" rows="3" placeholder="اكتب ردك هنا..."></textarea>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="responseDate" class="form-label" id="responseDateLabel">تاريخ الرد</label>
                  <input type="date" id="responseDate" class="form-control">
                </div>
                <div class="col-md-6 mb-3">
                  <label for="status" class="form-label" id="statusLabel">الحالة</label>
                  <select id="status" class="form-control">
                    <option value="pending">قيد الانتظار</option>
                    <option value="responded">تم الرد</option>
                    <option value="resolved">تم الحل</option>
                    <option value="disputed">متنازع عليها</option>
                    <option value="under_review">قيد المراجعة</option>
                    <option value="rejected">مرفوض</option>
                  </select>
                </div>
              </div>
            </div>
            
            <!-- Dispute Section -->
            <div class="dispute-section">
              <h5><i class="bi bi-exclamation-triangle"></i> <span id="disputeTitle">نزاع و أدلة</span></h5>
              <div class="row">
                <div class="col-12 mb-3">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="isDisputed" onchange="toggleDisputeSection()">
                    <label class="form-check-label" for="isDisputed" id="isDisputedLabel">
                      تم رفع نزاع بشأن هذه الحالة
                    </label>
                  </div>
                </div>
                <div id="disputeDetails" style="display: none;">
                  <div class="col-12 mb-3">
                    <label for="disputeReason" class="form-label" id="disputeReasonLabel">سبب النزاع</label>
                    <textarea id="disputeReason" class="form-control" rows="3" placeholder="اشرح سبب النزاع..."></textarea>
                  </div>
                  <div class="col-12 mb-3">
                    <label class="form-label" id="evidenceLabel">الأدلة (صور أو فيديو)</label>
                    <div class="mb-2">
                      <input type="file" id="evidenceFiles" class="form-control" accept="image/*,video/*" multiple onchange="addEvidence(this)">
                    </div>
                    <div id="evidenceContainer" class="border rounded p-2 bg-light min-height-100">
                      <p class="text-muted mb-0" id="noEvidence">لا توجد أدلة مضافة</p>
                    </div>
                  </div>
                  <div class="col-12 mb-3">
                    <label for="emailTemplate" class="form-label" id="emailTemplateLabel">نموذج البريد الإلكتروني</label>
                    <textarea id="emailTemplate" class="form-control" rows="10" placeholder="نموذج البريد الإلكتروني للرد على النزاع..."></textarea>
                    <div class="form-check mt-2">
                      <input class="form-check-input" type="checkbox" id="useDefaultTemplate" onchange="loadDefaultTemplate()">
                      <label class="form-check-label" for="useDefaultTemplate" id="useDefaultTemplateLabel">
                        استخدام النموذج الافتراضي
                      </label>
                    </div>
                  </div>
                  <div class="email-template" id="emailPreview" style="display: none;">
                    <h6 id="emailPreviewTitle">معاينة البريد الإلكتروني:</h6>
                    <div id="emailContent"></div>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancelBtn">إلغاء</button>
          <button type="button" class="btn btn-success" onclick="saveCase()" id="saveBtn">💾 حفظ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Cases Table -->
  <div class="table-responsive">
    <table id="casesTable" class="table table-bordered table-striped mt-3 text-center align-middle">
      <thead class="table-dark">
        <tr>
          <th id="thOrderId">رقم الطلب</th>
          <th id="thOutlet">الفرع</th>
          <th id="thDate">التاريخ</th>
          <th id="thItems">العناصر</th>
          <th id="thAmount">المبلغ</th>
          <th id="thReason">السبب</th>
          <th id="thStatus">الحالة</th>
          <th id="thActions">إجراءات</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Toast Container -->
  <div class="toast-container"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Language translations
    const translations = {
      ar: {
        systemTitle: "نظام إدارة التعويضات",
        totalCasesTitle: "إجمالي الحالات",
        pendingTitle: "قيد الانتظار",
        resolvedTitle: "تم الحل",
        disputedTitle: "متنازع عليها",
        underReviewTitle: "قيد المراجعة",
        totalAmountTitle: "إجمالي المبلغ",
        addCaseBtn: "➕ إضافة حالة جديدة",
        exportBtn: "تصدير البيانات",
        filterAll: "الكل",
        filterPending: "قيد الانتظار",
        filterResponded: "تم الرد",
        filterResolved: "تم الحل",
        filterDisputed: "متنازع عليها",
        filterUnderReview: "قيد المراجعة",
        filterRejected: "مرفوض",
        modalTitleAdd: "إضافة حالة جديدة",
        modalTitleEdit: "تعديل حالة",
        orderIdLabel: "رقم الطلب",
        outletLabel: "الفرع",
        orderDateLabel: "تاريخ الطلب",
        partnerLabel: "الشريك",
        referenceIdLabel: "رقم المرجع",
        itemsTitle: "العناصر",
        quantityLabel: "الكمية",
        itemNameLabel: "اسم العنصر",
        itemCategoryLabel: "الفئة",
        itemPriceLabel: "السعر",
        itemDescriptionLabel: "الوصف",
        addItemBtn: "إضافة عنصر",
        financialTitle: "التفاصيل المالية",
        basketAmountLabel: "إجمالي السلة",
        promoCodeLabel: "رمز العرض",
        promoAmountLabel: "قيمة العرض",
        totalAmountLabel: "الإجمالي",
        deductedAmountLabel: "المبلغ المسترد",
        refundDateLabel: "تاريخ الاسترداد",
        locationLabel: "الموقع",
        reasonTitle: "السبب وملاحظات العميل",
        reasonLabel: "السبب الرئيسي",
        customerReasonLabel: "سبب العميل",
        selectedItemsLabel: "العناصر المحددة من العميل",
        noItemsSelected: "لا توجد عناصر محددة",
        customerNotesLabel: "ملاحظات العميل",
        itemImageLabel: "صورة العنصر",
        responseTitle: "الرد على العميل",
        responseLabel: "نص الرد",
        responseDateLabel: "تاريخ الرد",
        statusLabel: "الحالة",
        disputeTitle: "نزاع و أدلة",
        isDisputedLabel: "تم رفع نزاع بشأن هذه الحالة",
        disputeReasonLabel: "سبب النزاع",
        evidenceLabel: "الأدلة (صور أو فيديو)",
        noEvidence: "لا توجد أدلة مضافة",
        emailTemplateLabel: "نموذج البريد الإلكتروني",
        useDefaultTemplateLabel: "استخدام النموذج الافتراضي",
        emailPreviewTitle: "معاينة البريد الإلكتروني:",
        cancelBtn: "إلغاء",
        saveBtn: "💾 حفظ",
        editBtn: "✏️ تعديل",
        deleteBtn: "🗑️ حذف",
        confirmDelete: "⚠️ هل أنت متأكد أنك تريد حذف هذه الحالة؟",
        orderIdError: "يرجى إدخال رقم الطلب",
        successSave: "تم حفظ الحالة بنجاح",
        successDelete: "تم حذف الحالة بنجاح",
        noData: "لا توجد حالات مسجلة",
        searchPlaceholder: "بحث في الحالات...",
        thOrderId: "رقم الطلب",
        thOutlet: "الفرع",
        thDate: "التاريخ",
        thItems: "العناصر",
        thAmount: "المبلغ",
        thReason: "السبب",
        thStatus: "الحالة",
        thActions: "إجراءات",
        langToggleText: "English",
        reasonSpilled: "تسريب / تلف",
        reasonWrong: "عنصر خاطئ",
        reasonMissingMain: "عنصر رئيسي مفقود",
        reasonMissingSide: "عنصر جانبي مفقود",
        reasonOvercooked: "الطعام مطهو أكثر من اللازم",
        reasonUndercooked: "الطعام غير ناضج",
        reasonSmell: "رائحة كريهة",
        reasonHair: "شعر في الطعام",
        reasonInedible: "الطعام غير صالح للأكل",
        reasonOther: "أخرى",
        statusPending: "قيد الانتظار",
        statusResponded: "تم الرد",
        statusResolved: "تم الحل",
        statusDisputed: "متنازع عليها",
        statusUnderReview: "قيد المراجعة",
        statusRejected: "مرفوض",
        orderInfoTitle: "معلومات الطلب",
        defaultEmailTemplate: `فريق كريم المحترم،

نود إثارة نزاع بخصوص الطلب التالي:
رقم المرجع: {referenceId}
التاريخ: {orderDate}
الموقع: {location}
مبلغ الطلب (درهم إماراتي): {totalAmount}

هذا الطلب تم تحضيره بالفعل وتسليمه بنجاح. ومع ذلك، تلقينا إشعار إلغاء بعد ذلك. نطلب منكم مراجعة هذه الحالة وضمان معالجة الدفعة، حيث تم تقديم الخدمة بالكامل.

نتطلع إلى دعمكم العاجل.

مع خالص التقدير،
{managerName}
مدير مركز الاتصال | {restaurantName}
📞 {managerPhone}
✉️ {managerEmail}
🌐 {restaurantWebsite}
"تقديم خدمة استثنائية، مكالمة واحدة تلو الأخرى."`
      },
      en: {
        systemTitle: "Compensation Management System",
        totalCasesTitle: "Total Cases",
        pendingTitle: "Pending",
        resolvedTitle: "Resolved",
        disputedTitle: "Disputed",
        underReviewTitle: "Under Review",
        totalAmountTitle: "Total Amount",
        addCaseBtn: "➕ Add New Case",
        exportBtn: "Export Data",
        filterAll: "All",
        filterPending: "Pending",
        filterResponded: "Responded",
        filterResolved: "Resolved",
        filterDisputed: "Disputed",
        filterUnderReview: "Under Review",
        filterRejected: "Rejected",
        modalTitleAdd: "Add New Case",
        modalTitleEdit: "Edit Case",
        orderIdLabel: "Order ID",
        outletLabel: "Outlet",
        orderDateLabel: "Order Date",
        partnerLabel: "Partner",
        referenceIdLabel: "Reference ID",
        itemsTitle: "Items",
        quantityLabel: "Quantity",
        itemNameLabel: "Item Name",
        itemCategoryLabel: "Category",
        itemPriceLabel: "Price",
        itemDescriptionLabel: "Description",
        addItemBtn: "Add Item",
        financialTitle: "Financial Details",
        basketAmountLabel: "Basket Amount",
        promoCodeLabel: "Promo Code",
        promoAmountLabel: "Promo Amount",
        totalAmountLabel: "Total",
        deductedAmountLabel: "Refund Amount",
        refundDateLabel: "Refund Date",
        locationLabel: "Location",
        reasonTitle: "Reason and Customer Feedback",
        reasonLabel: "Main Reason",
        customerReasonLabel: "Customer Reason",
        selectedItemsLabel: "Customer Selected Items",
        noItemsSelected: "No items selected",
        customerNotesLabel: "Customer Notes",
        itemImageLabel: "Item Image",
        responseTitle: "Response to Customer",
        responseLabel: "Response Text",
        responseDateLabel: "Response Date",
        statusLabel: "Status",
        disputeTitle: "Dispute & Evidence",
        isDisputedLabel: "A dispute has been raised for this case",
        disputeReasonLabel: "Dispute Reason",
        evidenceLabel: "Evidence (Images or Videos)",
        noEvidence: "No evidence added",
        emailTemplateLabel: "Email Template",
        useDefaultTemplateLabel: "Use Default Template",
        emailPreviewTitle: "Email Preview:",
        cancelBtn: "Cancel",
        saveBtn: "💾 Save",
        editBtn: "✏️ Edit",
        deleteBtn: "🗑️ Delete",
        confirmDelete: "⚠️ Are you sure you want to delete this case?",
        orderIdError: "Please enter an order ID",
        successSave: "Case saved successfully",
        successDelete: "Case deleted successfully",
        noData: "No cases recorded",
        searchPlaceholder: "Search cases...",
        thOrderId: "Order ID",
        thOutlet: "Outlet",
        thDate: "Date",
        thItems: "Items",
        thAmount: "Amount",
        thReason: "Reason",
        thStatus: "Status",
        thActions: "Actions",
        langToggleText: "العربية",
        reasonSpilled: "Spilled / Damaged",
        reasonWrong: "Wrong Item",
        reasonMissingMain: "Missing Main Item",
        reasonMissingSide: "Missing Side Item",
        reasonOvercooked: "Food is Overcooked",
        reasonUndercooked: "Food is Undercooked",
        reasonSmell: "Foul Smell",
        reasonHair: "Hair in the food",
        reasonInedible: "Food is not edible",
        reasonOther: "Other",
        statusPending: "Pending",
        statusResponded: "Responded",
        statusResolved: "Resolved",
        statusDisputed: "Disputed",
        statusUnderReview: "Under Review",
        statusRejected: "Rejected",
        orderInfoTitle: "Order Information",
        defaultEmailTemplate: `Dear Careem Team,

We would like to raise a dispute regarding the following order:
Reference ID: {referenceId}
Date: {orderDate}
Location: {location}
Order Amount (AED): {totalAmount}

This order was already prepared and delivered successfully. However, we received a cancellation notification afterward. We kindly request you to review this case and ensure the payout is processed, as the service was completed.
Looking forward to your urgent support.

Best regards,  
{managerName}  
Call Center Manager | {restaurantName}  
📞 {managerPhone}  
✉️ {managerEmail}  
🌐 {restaurantWebsite}  
"Delivering exceptional service, one call at a time."`
      }
    };

    // Global variables
    let cases = [];
    let currentLang = 'ar';
    let filteredCases = [];
    let evidenceFiles = [];

    // Initialize the app
    document.addEventListener('DOMContentLoaded', function() {
      loadFromLocalStorage();
      renderTable();
      updateStats();
      updateLanguage();
      
      // Set default dates
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('orderDate').value = today;
      document.getElementById('responseDate').value = today;
      document.getElementById('refundDate').value = today;
    });

    // Language functions
    function toggleLanguage() {
      currentLang = currentLang === 'ar' ? 'en' : 'ar';
      document.documentElement.lang = currentLang;
      document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
      updateLanguage();
      renderTable();
    }

    function updateLanguage() {
      const t = translations[currentLang];
      
      // Update all text elements
      document.getElementById('systemTitle').textContent = t.systemTitle;
      document.getElementById('totalCasesTitle').textContent = t.totalCasesTitle;
      document.getElementById('pendingTitle').textContent = t.pendingTitle;
      document.getElementById('resolvedTitle').textContent = t.resolvedTitle;
      document.getElementById('disputedTitle').textContent = t.disputedTitle;
      document.getElementById('underReviewTitle').textContent = t.underReviewTitle;
      document.getElementById('totalAmountTitle').textContent = t.totalAmountTitle;
      document.getElementById('addCaseBtn').innerHTML = `<i class="bi bi-plus-circle"></i> ${t.addCaseBtn}`;
      document.getElementById('exportBtn').innerHTML = `<i class="bi bi-download"></i> ${t.exportBtn}`;
      document.getElementById('filterAll').textContent = t.filterAll;
      document.getElementById('filterPending').textContent = t.filterPending;
      document.getElementById('filterResponded').textContent = t.filterResponded;
      document.getElementById('filterResolved').textContent = t.filterResolved;
      document.getElementById('filterDisputed').textContent = t.filterDisputed;
      document.getElementById('filterUnderReview').textContent = t.filterUnderReview;
      document.getElementById('filterRejected').textContent = t.filterRejected;
      document.getElementById('cancelBtn').textContent = t.cancelBtn;
      document.getElementById('saveBtn').innerHTML = t.saveBtn;
      document.getElementById('searchInput').placeholder = t.searchPlaceholder;
      document.getElementById('langToggleText').textContent = t.langToggleText;
      
      // Update table headers
      document.getElementById('thOrderId').textContent = t.thOrderId;
      document.getElementById('thOutlet').textContent = t.thOutlet;
      document.getElementById('thDate').textContent = t.thDate;
      document.getElementById('thItems').textContent = t.thItems;
      document.getElementById('thAmount').textContent = t.thAmount;
      document.getElementById('thReason').textContent = t.thReason;
      document.getElementById('thStatus').textContent = t.thStatus;
      document.getElementById('thActions').textContent = t.thActions;
      
      // Update form labels
      document.getElementById('orderInfoTitle').textContent = t.orderInfoTitle;
      document.getElementById('orderIdLabel').textContent = t.orderIdLabel;
      document.getElementById('outletLabel').textContent = t.outletLabel;
      document.getElementById('orderDateLabel').textContent = t.orderDateLabel;
      document.getElementById('partnerLabel').textContent = t.partnerLabel;
      document.getElementById('referenceIdLabel').textContent = t.referenceIdLabel;
      document.getElementById('itemsTitle').textContent = t.itemsTitle;
      document.getElementById('quantityLabel').textContent = t.quantityLabel;
      document.getElementById('itemNameLabel').textContent = t.itemNameLabel;
      document.getElementById('itemCategoryLabel').textContent = t.itemCategoryLabel;
      document.getElementById('itemPriceLabel').textContent = t.itemPriceLabel;
      document.getElementById('itemDescriptionLabel').textContent = t.itemDescriptionLabel;
      document.getElementById('addItemBtn').textContent = t.addItemBtn;
      document.getElementById('financialTitle').textContent = t.financialTitle;
      document.getElementById('basketAmountLabel').textContent = t.basketAmountLabel;
      document.getElementById('promoCodeLabel').textContent = t.promoCodeLabel;
      document.getElementById('promoAmountLabel').textContent = t.promoAmountLabel;
      document.getElementById('totalAmountLabel').textContent = t.totalAmountLabel;
      document.getElementById('deductedAmountLabel').textContent = t.deductedAmountLabel;
      document.getElementById('refundDateLabel').textContent = t.refundDateLabel;
      document.getElementById('locationLabel').textContent = t.locationLabel;
      document.getElementById('reasonTitle').textContent = t.reasonTitle;
      document.getElementById('reasonLabel').textContent = t.reasonLabel;
      document.getElementById('customerReasonLabel').textContent = t.customerReasonLabel;
      document.getElementById('selectedItemsLabel').textContent = t.selectedItemsLabel;
      document.getElementById('noItemsSelected').textContent = t.noItemsSelected;
      document.getElementById('customerNotesLabel').textContent = t.customerNotesLabel;
      document.getElementById('itemImageLabel').textContent = t.itemImageLabel;
      document.getElementById('responseTitle').textContent = t.responseTitle;
      document.getElementById('responseLabel').textContent = t.responseLabel;
      document.getElementById('responseDateLabel').textContent = t.responseDateLabel;
      document.getElementById('statusLabel').textContent = t.statusLabel;
      document.getElementById('disputeTitle').textContent = t.disputeTitle;
      document.getElementById('isDisputedLabel').textContent = t.isDisputedLabel;
      document.getElementById('disputeReasonLabel').textContent = t.disputeReasonLabel;
      document.getElementById('evidenceLabel').textContent = t.evidenceLabel;
      document.getElementById('noEvidence').textContent = t.noEvidence;
      document.getElementById('emailTemplateLabel').textContent = t.emailTemplateLabel;
      document.getElementById('useDefaultTemplateLabel').textContent = t.useDefaultTemplateLabel;
      document.getElementById('emailPreviewTitle').textContent = t.emailPreviewTitle;
      document.getElementById('orderIdError').textContent = t.orderIdError;
      
      // Update form options
      updateFormOptions();
    }

    function updateFormOptions() {
      const t = translations[currentLang];
      
      // Update reason options
      const reasonSelect = document.getElementById('reason');
      reasonSelect.innerHTML = `
        <option value="spilled">${t.reasonSpilled}</option>
        <option value="wrong">${t.reasonWrong}</option>
        <option value="missing_main">${t.reasonMissingMain}</option>
        <option value="missing_side">${t.reasonMissingSide}</option>
        <option value="overcooked">${t.reasonOvercooked}</option>
        <option value="undercooked">${t.reasonUndercooked}</option>
        <option value="smell">${t.reasonSmell}</option>
        <option value="hair">${t.reasonHair}</option>
        <option value="inedible">${t.reasonInedible}</option>
        <option value="other">${t.reasonOther}</option>
      `;
      
      // Update status options
      const statusSelect = document.getElementById('status');
      statusSelect.innerHTML = `
        <option value="pending">${t.statusPending}</option>
        <option value="responded">${t.statusResponded}</option>
        <option value="resolved">${t.statusResolved}</option>
        <option value="disputed">${t.statusDisputed}</option>
        <option value="under_review">${t.statusUnderReview}</option>
        <option value="rejected">${t.statusRejected}</option>
      `;
    }

    // Item management functions
    function addItem() {
      const itemsContainer = document.getElementById('itemsContainer');
      const newItem = document.createElement('div');
      newItem.className = 'item-row';
      newItem.innerHTML = `
        <div class="row align-items-center">
          <div class="col-md-1">
            <label class="form-label">${translations[currentLang].quantityLabel}</label>
            <input type="number" class="form-control item-quantity" value="1" min="1">
          </div>
          <div class="col-md-4">
            <label class="form-label">${translations[currentLang].itemNameLabel}</label>
            <input type="text" class="form-control item-name" placeholder="${translations[currentLang].itemNameLabel}">
          </div>
          <div class="col-md-3">
            <label class="form-label">${translations[currentLang].itemCategoryLabel}</label>
            <input type="text" class="form-control item-category" placeholder="${translations[currentLang].itemCategoryLabel}">
          </div>
          <div class="col-md-2">
            <label class="form-label">${translations[currentLang].itemPriceLabel}</label>
            <input type="number" class="form-control item-price" value="0" min="0" step="0.01">
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button type="button" class="btn btn-danger btn-sm" onclick="removeItem(this)">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </div>
        <div class="row mt-2">
          <div class="col-12">
            <label class="form-label">${translations[currentLang].itemDescriptionLabel}</label>
            <textarea class="form-control item-description" rows="1" placeholder="${translations[currentLang].itemDescriptionLabel}"></textarea>
          </div>
        </div>
      `;
      itemsContainer.appendChild(newItem);
      
      // Add event listeners to calculate totals
      newItem.querySelectorAll('.item-price, .item-quantity').forEach(input => {
        input.addEventListener('input', calculateTotals);
      });
    }

    function removeItem(button) {
      const itemRow = button.closest('.item-row');
      itemRow.remove();
      calculateTotals();
      updateSelectedItems();
    }

    function calculateTotals() {
      let basketAmount = 0;
      document.querySelectorAll('.item-row').forEach(row => {
        const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
        const price = parseFloat(row.querySelector('.item-price').value) || 0;
        basketAmount += quantity * price;
      });
      
      const promoAmount = parseFloat(document.getElementById('promoAmount').value) || 0;
      const totalAmount = basketAmount - promoAmount;
      
      document.getElementById('basketAmount').value = basketAmount.toFixed(2);
      document.getElementById('totalAmount').value = totalAmount.toFixed(2);
    }

    // Image preview function
    function previewImage(input) {
      const preview = document.getElementById('imagePreview');
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          preview.src = e.target.result;
          preview.classList.remove('d-none');
        };
        reader.readAsDataURL(input.files[0]);
      } else {
        preview.classList.add('d-none');
      }
    }

    // Update selected items display
    function updateSelectedItems() {
      const container = document.getElementById('selectedItemsContainer');
      const items = document.querySelectorAll('.item-row');
      let html = '';
      
      items.forEach((item, index) => {
        const name = item.querySelector('.item-name').value;
        const quantity = item.querySelector('.item-quantity').value;
        
        if (name) {
          html += `<div class="form-check">
            <input class="form-check-input" type="checkbox" value="${index}" id="itemCheck${index}">
            <label class="form-check-label" for="itemCheck${index}">
              ${quantity}x ${name}
            </label>
          </div>`;
        }
      });
      
      if (html) {
        container.innerHTML = html;
      } else {
        container.innerHTML = `<p class="text-muted mb-0">${translations[currentLang].noItemsSelected}</p>`;
      }
    }

    // Dispute functions
    function toggleDisputeSection() {
      const isDisputed = document.getElementById('isDisputed').checked;
      const disputeDetails = document.getElementById('disputeDetails');
      
      if (isDisputed) {
        disputeDetails.style.display = 'block';
        // Update status to disputed if not already
        const statusSelect = document.getElementById('status');
        if (statusSelect.value !== 'disputed' && statusSelect.value !== 'under_review' && statusSelect.value !== 'rejected') {
          statusSelect.value = 'disputed';
        }
      } else {
        disputeDetails.style.display = 'none';
      }
    }

    function addEvidence(input) {
      const container = document.getElementById('evidenceContainer');
      const noEvidence = document.getElementById('noEvidence');
      
      if (input.files && input.files.length > 0) {
        // Hide "no evidence" message
        if (noEvidence) {
          noEvidence.style.display = 'none';
        }
        
        // Add each file as evidence
        Array.from(input.files).forEach(file => {
          const evidenceId = 'evidence-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
          
          const evidenceItem = document.createElement('div');
          evidenceItem.className = 'evidence-item';
          evidenceItem.id = evidenceId;
          
          const isImage = file.type.startsWith('image/');
          const icon = isImage ? 'bi-image' : 'bi-camera-video';
          
          evidenceItem.innerHTML = `
            <i class="bi ${icon}"></i> ${file.name}
            <span class="evidence-remove" onclick="removeEvidence('${evidenceId}')">×</span>
          `;
          
          container.appendChild(evidenceItem);
          
          // Store file reference
          evidenceFiles.push({
            id: evidenceId,
            file: file
          });
        });
      }
      
      // Reset input to allow selecting the same file again
      input.value = '';
    }

    function removeEvidence(evidenceId) {
      // Remove from DOM
      const evidenceElement = document.getElementById(evidenceId);
      if (evidenceElement) {
        evidenceElement.remove();
      }
      
      // Remove from files array
      evidenceFiles = evidenceFiles.filter(e => e.id !== evidenceId);
      
      // Show "no evidence" message if no files left
      const container = document.getElementById('evidenceContainer');
      const remainingEvidence = container.querySelectorAll('.evidence-item');
      
      if (remainingEvidence.length === 0) {
        const noEvidence = document.getElementById('noEvidence');
        if (noEvidence) {
          noEvidence.style.display = 'block';
        }
      }
    }

    function loadDefaultTemplate() {
      const useDefault = document.getElementById('useDefaultTemplate').checked;
      const emailTemplate = document.getElementById('emailTemplate');
      const emailPreview = document.getElementById('emailPreview');
      const emailContent = document.getElementById('emailContent');
      
      if (useDefault) {
        const t = translations[currentLang];
        const template = t.defaultEmailTemplate;
        
        // Replace placeholders with actual data
        const referenceId = document.getElementById('referenceId').value || 'N/A';
        const orderDate = document.getElementById('orderDate').value || 'N/A';
        const location = document.getElementById('location').value || 'N/A';
        const totalAmount = document.getElementById('totalAmount').value || '0';
        
        // Default restaurant info
        const managerName = 'Ahmed Kenawy';
        const restaurantName = 'Crispy Chicken';
        const managerPhone = '+971 50 902 1993';
        const managerEmail = 'kenawe@crispychicken.rest';
        const restaurantWebsite = 'https://crispychicken-uae.com';
        
        let filledTemplate = template
          .replace('{referenceId}', referenceId)
          .replace('{orderDate}', orderDate)
          .replace('{location}', location)
          .replace('{totalAmount}', totalAmount)
          .replace('{managerName}', managerName)
          .replace('{restaurantName}', restaurantName)
          .replace('{managerPhone}', managerPhone)
          .replace('{managerEmail}', managerEmail)
          .replace('{restaurantWebsite}', restaurantWebsite);
        
        emailTemplate.value = filledTemplate;
        emailContent.textContent = filledTemplate;
        emailPreview.style.display = 'block';
      } else {
        emailPreview.style.display = 'none';
      }
    }

    // Case management functions
    function openAddCase() {
      const t = translations[currentLang];
      document.getElementById("modalTitle").textContent = t.modalTitleAdd;
      document.getElementById("caseForm").reset();
      document.getElementById("editIndex").value = "";
      document.getElementById("caseForm").classList.remove('was-validated');
      
      // Reset items to one empty item
      const itemsContainer = document.getElementById('itemsContainer');
      itemsContainer.innerHTML = `
        <div class="item-row">
          <div class="row align-items-center">
            <div class="col-md-1">
              <label class="form-label">${t.quantityLabel}</label>
              <input type="number" class="form-control item-quantity" value="1" min="1">
            </div>
            <div class="col-md-4">
              <label class="form-label">${t.itemNameLabel}</label>
              <input type="text" class="form-control item-name" placeholder="${t.itemNameLabel}">
            </div>
            <div class="col-md-3">
              <label class="form-label">${t.itemCategoryLabel}</label>
              <input type="text" class="form-control item-category" placeholder="${t.itemCategoryLabel}">
            </div>
            <div class="col-md-2">
              <label class="form-label">${t.itemPriceLabel}</label>
              <input type="number" class="form-control item-price" value="0" min="0" step="0.01">
            </div>
            <div class="col-md-2 d-flex align-items-end">
              <button type="button" class="btn btn-danger btn-sm" onclick="removeItem(this)">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
          <div class="row mt-2">
            <div class="col-12">
              <label class="form-label">${t.itemDescriptionLabel}</label>
              <textarea class="form-control item-description" rows="1" placeholder="${t.itemDescriptionLabel}"></textarea>
            </div>
          </div>
        </div>
      `;
      
      // Reset image preview
      document.getElementById('imagePreview').classList.add('d-none');
      
      // Reset dispute section
      document.getElementById('isDisputed').checked = false;
      document.getElementById('disputeDetails').style.display = 'none';
      document.getElementById('evidenceContainer').innerHTML = `<p class="text-muted mb-0">${t.noEvidence}</p>`;
      document.getElementById('emailPreview').style.display = 'none';
      evidenceFiles = [];
      
      // Add event listeners
      document.querySelectorAll('.item-price, .item-quantity').forEach(input => {
        input.addEventListener('input', calculateTotals);
      });
      
      // Set default dates
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('orderDate').value = today;
      document.getElementById('responseDate').value = today;
      document.getElementById('refundDate').value = today;
      
      // Reset totals
      calculateTotals();
      updateSelectedItems();
    }

    function saveCase() {
      const t = translations[currentLang];
      const form = document.getElementById("caseForm");
      
      // Validate form
      if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return;
      }
      
      // Collect items data
      const items = [];
      document.querySelectorAll('.item-row').forEach(row => {
        const name = row.querySelector('.item-name').value;
        if (name) {
          items.push({
            quantity: parseInt(row.querySelector('.item-quantity').value) || 0,
            name: name,
            category: row.querySelector('.item-category').value,
            price: parseFloat(row.querySelector('.item-price').value) || 0,
            description: row.querySelector('.item-description').value
          });
        }
      });
      
      // Collect selected items
      const selectedItems = [];
      document.querySelectorAll('#selectedItemsContainer input[type="checkbox"]:checked').forEach(checkbox => {
        const index = parseInt(checkbox.value);
        if (items[index]) {
          selectedItems.push({
            quantity: items[index].quantity,
            name: items[index].name
          });
        }
      });
      
      // Get image data
      let imageData = null;
      const imageFile = document.getElementById('itemImage').files[0];
      if (imageFile) {
        // In a real application, you would upload the image to a server
        // For this demo, we'll just store the filename
        imageData = imageFile.name;
      }
      
      // Collect dispute data
      const isDisputed = document.getElementById('isDisputed').checked;
      let disputeData = null;
      
      if (isDisputed) {
        // Collect evidence files (just names for demo)
        const evidenceNames = evidenceFiles.map(e => e.file.name);
        
        disputeData = {
          reason: document.getElementById('disputeReason').value,
          evidence: evidenceNames,
          emailTemplate: document.getElementById('emailTemplate').value
        };
      }
      
      const caseData = {
        orderId: document.getElementById("orderId").value,
        outlet: document.getElementById("outlet").value,
        orderDate: document.getElementById("orderDate").value,
        partner: document.getElementById("partner").value,
        referenceId: document.getElementById("referenceId").value,
        items: items,
        basketAmount: parseFloat(document.getElementById("basketAmount").value) || 0,
        promoCode: document.getElementById("promoCode").value,
        promoAmount: parseFloat(document.getElementById("promoAmount").value) || 0,
        totalAmount: parseFloat(document.getElementById("totalAmount").value) || 0,
        deductedAmount: parseFloat(document.getElementById("deductedAmount").value) || 0,
        refundDate: document.getElementById("refundDate").value,
        location: document.getElementById("location").value,
        reason: document.getElementById("reason").value,
        customerReason: document.getElementById("customerReason").value,
        selectedItems: selectedItems,
        customerNotes: document.getElementById("customerNotes").value,
        image: imageData,
        response: document.getElementById("response").value,
        responseDate: document.getElementById("responseDate").value,
        status: document.getElementById("status").value,
        isDisputed: isDisputed,
        dispute: disputeData,
        dateAdded: new Date().toISOString()
      };
      
      const editIndex = document.getElementById("editIndex").value;
      if (editIndex === "") {
        cases.push(caseData);
        showToast(t.successSave, 'success');
      } else {
        cases[editIndex] = caseData;
        showToast(t.successSave, 'success');
      }
      
      saveToLocalStorage();
      renderTable();
      updateStats();
      bootstrap.Modal.getInstance(document.getElementById("caseModal")).hide();
    }

    function editCase(index) {
      const t = translations[currentLang];
      const c = cases[index];
      document.getElementById("modalTitle").textContent = t.modalTitleEdit;
      
      // Populate basic fields
      document.getElementById("orderId").value = c.orderId;
      document.getElementById("outlet").value = c.outlet;
      document.getElementById("orderDate").value = c.orderDate;
      document.getElementById("partner").value = c.partner;
      document.getElementById("referenceId").value = c.referenceId || '';
      document.getElementById("promoCode").value = c.promoCode;
      document.getElementById("promoAmount").value = c.promoAmount;
      document.getElementById("deductedAmount").value = c.deductedAmount;
      document.getElementById("refundDate").value = c.refundDate;
      document.getElementById("location").value = c.location || '';
      document.getElementById("reason").value = c.reason;
      document.getElementById("customerReason").value = c.customerReason;
      document.getElementById("customerNotes").value = c.customerNotes;
      document.getElementById("response").value = c.response;
      document.getElementById("responseDate").value = c.responseDate;
      document.getElementById("status").value = c.status;
      
      // Populate items
      const itemsContainer = document.getElementById('itemsContainer');
      itemsContainer.innerHTML = '';
      
      c.items.forEach(item => {
        const newItem = document.createElement('div');
        newItem.className = 'item-row';
        newItem.innerHTML = `
          <div class="row align-items-center">
            <div class="col-md-1">
              <label class="form-label">${t.quantityLabel}</label>
              <input type="number" class="form-control item-quantity" value="${item.quantity}" min="1">
            </div>
            <div class="col-md-4">
              <label class="form-label">${t.itemNameLabel}</label>
              <input type="text" class="form-control item-name" value="${item.name}" placeholder="${t.itemNameLabel}">
            </div>
            <div class="col-md-3">
              <label class="form-label">${t.itemCategoryLabel}</label>
              <input type="text" class="form-control item-category" value="${item.category}" placeholder="${t.itemCategoryLabel}">
            </div>
            <div class="col-md-2">
              <label class="form-label">${t.itemPriceLabel}</label>
              <input type="number" class="form-control item-price" value="${item.price}" min="0" step="0.01">
            </div>
            <div class="col-md-2 d-flex align-items-end">
              <button type="button" class="btn btn-danger btn-sm" onclick="removeItem(this)">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
          <div class="row mt-2">
            <div class="col-12">
              <label class="form-label">${t.itemDescriptionLabel}</label>
              <textarea class="form-control item-description" rows="1" placeholder="${t.itemDescriptionLabel}">${item.description}</textarea>
            </div>
          </div>
        `;
        itemsContainer.appendChild(newItem);
      });
      
      // Add event listeners
      document.querySelectorAll('.item-price, .item-quantity').forEach(input => {
        input.addEventListener('input', calculateTotals);
      });
      
      // Update totals
      calculateTotals();
      
      // Update selected items
      updateSelectedItems();
      
      // Check selected items
      setTimeout(() => {
        c.selectedItems.forEach(selectedItem => {
          document.querySelectorAll('#selectedItemsContainer input[type="checkbox"]').forEach(checkbox => {
            const index = parseInt(checkbox.value);
            const item = c.items[index];
            if (item && item.name === selectedItem.name && item.quantity === selectedItem.quantity) {
              checkbox.checked = true;
            }
          });
        });
      }, 100);
      
      // Show image if exists
      const imagePreview = document.getElementById('imagePreview');
      if (c.image) {
        // In a real application, you would load the image from the server
        // For this demo, we'll just show a placeholder
        imagePreview.src = 'https://via.placeholder.com/300x200?text=Image+Preview';
        imagePreview.classList.remove('d-none');
      } else {
        imagePreview.classList.add('d-none');
      }
      
      // Populate dispute data
      document.getElementById('isDisputed').checked = c.isDisputed || false;
      const disputeDetails = document.getElementById('disputeDetails');
      
      if (c.isDisputed && c.dispute) {
        disputeDetails.style.display = 'block';
        document.getElementById('disputeReason').value = c.dispute.reason || '';
        document.getElementById('emailTemplate').value = c.dispute.emailTemplate || '';
        
        // Show evidence
        const evidenceContainer = document.getElementById('evidenceContainer');
        const noEvidence = document.getElementById('noEvidence');
        
        if (c.dispute.evidence && c.dispute.evidence.length > 0) {
          noEvidence.style.display = 'none';
          evidenceContainer.innerHTML = '';
          
          c.dispute.evidence.forEach((evidenceName, idx) => {
            const evidenceId = 'evidence-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            
            const evidenceItem = document.createElement('div');
            evidenceItem.className = 'evidence-item';
            evidenceItem.id = evidenceId;
            
            // Determine if it's an image or video based on extension
            const isImage = /\.(jpg|jpeg|png|gif|bmp|webp)$/i.test(evidenceName);
            const icon = isImage ? 'bi-image' : 'bi-camera-video';
            
            evidenceItem.innerHTML = `
              <i class="bi ${icon}"></i> ${evidenceName}
              <span class="evidence-remove" onclick="removeEvidence('${evidenceId}')">×</span>
            `;
            
            evidenceContainer.appendChild(evidenceItem);
            
            // Add to files array (mock)
            evidenceFiles.push({
              id: evidenceId,
              file: { name: evidenceName }
            });
          });
        } else {
          evidenceContainer.innerHTML = `<p class="text-muted mb-0">${t.noEvidence}</p>`;
        }
      } else {
        disputeDetails.style.display = 'none';
      }
      
      document.getElementById("editIndex").value = index;
      document.getElementById("caseForm").classList.remove('was-validated');
      new bootstrap.Modal(document.getElementById("caseModal")).show();
    }

    function deleteCase(index) {
      const t = translations[currentLang];
      if (confirm(t.confirmDelete)) {
        cases.splice(index, 1);
        saveToLocalStorage();
        renderTable();
        updateStats();
        showToast(t.successDelete, 'danger');
      }
    }

    // Table rendering functions
    function renderTable() {
      const t = translations[currentLang];
      const tbody = document.querySelector("#casesTable tbody");
      tbody.innerHTML = "";
      
      const casesToRender = filteredCases.length > 0 ? filteredCases : cases;
      
      if (casesToRender.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8" class="text-center py-3">${t.noData}</td></tr>`;
        return;
      }
      
      casesToRender.forEach((c, i) => {
        const originalIndex = cases.indexOf(c);
        const statusClass = `status-${c.status}`;
        const reasonText = getReasonText(c.reason);
        const statusText = getStatusText(c.status);
        
        // Format items for display
        const itemsDisplay = c.items.map(item => `${item.quantity}x ${item.name}`).join(', ');
        
        tbody.innerHTML += `
          <tr>
            <td>${c.orderId}</td>
            <td>${c.outlet}</td>
            <td>${c.orderDate}</td>
            <td>${itemsDisplay}</td>
            <td>${c.deductedAmount.toFixed(2)}</td>
            <td>${reasonText}</td>
            <td><span class="badge ${statusClass}">${statusText}</span></td>
            <td class="action-buttons">
              <button class="btn btn-sm btn-warning" onclick="editCase(${originalIndex})" title="${t.editBtn}">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-sm btn-danger" onclick="deleteCase(${originalIndex})" title="${t.deleteBtn}">
                <i class="bi bi-trash"></i>
              </button>
            </td>
          </tr>
        `;
      });
    }

    function getReasonText(reasonKey) {
      const t = translations[currentLang];
      switch(reasonKey) {
        case 'spilled': return t.reasonSpilled;
        case 'wrong': return t.reasonWrong;
        case 'missing_main': return t.reasonMissingMain;
        case 'missing_side': return t.reasonMissingSide;
        case 'overcooked': return t.reasonOvercooked;
        case 'undercooked': return t.reasonUndercooked;
        case 'smell': return t.reasonSmell;
        case 'hair': return t.reasonHair;
        case 'inedible': return t.reasonInedible;
        case 'other': return t.reasonOther;
        default: return reasonKey;
      }
    }

    function getStatusText(statusKey) {
      const t = translations[currentLang];
      switch(statusKey) {
        case 'pending': return t.statusPending;
        case 'responded': return t.statusResponded;
        case 'resolved': return t.statusResolved;
        case 'disputed': return t.statusDisputed;
        case 'under_review': return t.statusUnderReview;
        case 'rejected': return t.statusRejected;
        default: return statusKey;
      }
    }

    // Stats functions
    function updateStats() {
      const totalCases = cases.length;
      const pendingCases = cases.filter(c => c.status === 'pending').length;
      const resolvedCases = cases.filter(c => c.status === 'resolved').length;
      const disputedCases = cases.filter(c => c.status === 'disputed').length;
      const underReviewCases = cases.filter(c => c.status === 'under_review').length;
      const totalAmount = cases.reduce((sum, c) => sum + c.deductedAmount, 0);
      
      document.getElementById('totalCases').textContent = totalCases;
      document.getElementById('pendingCases').textContent = pendingCases;
      document.getElementById('resolvedCases').textContent = resolvedCases;
      document.getElementById('disputedCases').textContent = disputedCases;
      document.getElementById('underReviewCases').textContent = underReviewCases;
      document.getElementById('totalAmount').textContent = totalAmount.toFixed(2);
    }

    // Search and filter functions
    function searchCases() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const statusFilter = document.getElementById('filterStatus').value;
      
      filteredCases = cases.filter(c => {
        const matchesSearch = 
          c.orderId.toLowerCase().includes(searchTerm) ||
          c.outlet.toLowerCase().includes(searchTerm) ||
          c.customerNotes.toLowerCase().includes(searchTerm) ||
          getReasonText(c.reason).toLowerCase().includes(searchTerm) ||
          getStatusText(c.status).toLowerCase().includes(searchTerm) ||
          c.items.some(item => item.name.toLowerCase().includes(searchTerm));
          
        const matchesStatus = statusFilter === 'all' || c.status === statusFilter;
        
        return matchesSearch && matchesStatus;
      });
      
      renderTable();
    }

    function filterByStatus() {
      searchCases(); // Reuse search logic
    }

    // Data persistence functions
    function saveToLocalStorage() {
      localStorage.setItem('compensationCases', JSON.stringify(cases));
    }

    function loadFromLocalStorage() {
      const savedCases = localStorage.getItem('compensationCases');
      if (savedCases) {
        cases = JSON.parse(savedCases);
      }
    }

    // Export function
    function exportData() {
      const t = translations[currentLang];
      let csvContent = "data:text/csv;charset=utf-8,";
      
      // Add headers
      csvContent += `${t.thOrderId},${t.thOutlet},${t.thDate},${t.thItems},${t.thAmount},${t.thReason},${t.thStatus}\n`;
      
      // Add data
      cases.forEach(c => {
        const itemsDisplay = c.items.map(item => `${item.quantity}x ${item.name}`).join('; ');
        csvContent += `${c.orderId},${c.outlet},${c.orderDate},"${itemsDisplay}",${c.deductedAmount.toFixed(2)},${getReasonText(c.reason)},${getStatusText(c.status)}\n`;
      });
      
      // Create download link
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", `compensation_cases_${new Date().toISOString().slice(0,10)}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Toast notification function
    function showToast(message, type = 'info') {
      const toastContainer = document.querySelector('.toast-container');
      const toastId = 'toast-' + Date.now();
      
      const toastHTML = `
        <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="d-flex">
            <div class="toast-body">
              ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        </div>
      `;
      
      toastContainer.insertAdjacentHTML('beforeend', toastHTML);
      const toastElement = document.getElementById(toastId);
      const toast = new bootstrap.Toast(toastElement, { autohide: true, delay: 3000 });
      toast.show();
      
      toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
      });
    }
  </script>
</body>
</html>
